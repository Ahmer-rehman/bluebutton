<!-- SIP clients send FreeSWITCH a list of their IP addresses, from which -->
<!-- one address will be selected for use.  Which one depends on how the client -->
<!-- connected - connections from a private address space should use -->
<!-- the private address; connections from a public address should use -->
<!-- the public address.  Since BigBlueButton runs SIP through nginx as a proxy, -->
<!-- FreeSWITCH can't determine on its own how the client connected. -->

<!-- Therefore, two different FreeSWITCH profiles are used, listening on -->
<!-- different TCP ports for connections from localhost's nginx. -->

<!-- This is the "public" profile, listening for WS on port 5066 -->
<!-- and WSS on port 7443, used for connections from public IP addresses. -->

<!-- apply-candidate-acl prefers public IP addresses (wan_v4) -->
<!-- ext-rtp-ip and ext-sip-ip are set to this server's public address -->
<!-- local-network-acl is set to none (nothing is local; everything is NAT) -->

<profile name="public">

  <gateways>
    <!-- backwards compatibility requires us to include files in the external subdirectory -->
    <X-PRE-PROCESS cmd="include" data="external/*.xml"/>
  </gateways>

  <domains>
    <domain name="all" alias="false" parse="true"/>
  </domains>

  <settings>
    <X-PRE-PROCESS cmd="include" data="../sip_profile_common.xml"/>

    <!-- Unused by BBB, but FreeSWITCH won't run unless its specified -->
    <param name="sip-port" value="$${external_sip_port}"/>

    <!-- local-network-acl is used to determine if NAT is in use -->
    <!-- Due to nginx proxy, connection will always come from loopback, this will not match, NAT will apply -->
    <param name="local-network-acl" value="none"/>

    <param name="apply-candidate-acl" value="wan_v4.auto"/>
    <param name="apply-candidate-acl" value="rfc1918.auto"/>
    <param name="apply-candidate-acl" value="any_v4.auto"/>

    <!-- Name of the db to use for this profile -->
    <param name="dbname" value="sqlite://memory://file:public?mode=memory&amp;cache=shared"/>

    <!--
        DO NOT USE HOSTNAMES, ONLY IP ADDRESSES IN THESE SETTINGS!
    -->

    <param name="rtp-ip" value="$${local_ip_v4}"/>
    <param name="sip-ip" value="$${local_ip_v4}"/>
    <param name="ext-rtp-ip" value="$${external_rtp_ip}"/>
    <param name="ext-sip-ip" value="$${external_sip_ip}"/>

    <param name="ws-binding"  value="127.0.0.1:5066"/>
    <param name="wss-binding"  value="127.0.0.1:7443"/>

  </settings>
</profile>
