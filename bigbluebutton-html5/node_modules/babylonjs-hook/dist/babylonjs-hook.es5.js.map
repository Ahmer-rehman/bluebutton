{"version":3,"file":"babylonjs-hook.es5.js","sources":["../src/scene.tsx","../src/engine.tsx","../src/babylonjs-hook.tsx"],"sourcesContent":["import { Nullable, Scene } from '@babylonjs/core';\nimport { createContext, useContext } from 'react';\n\nexport type SceneContextType = {\n    scene: Nullable<Scene>\n    sceneReady: boolean\n};\n\nexport const SceneContext = createContext<SceneContextType>({\n    scene: null,\n    sceneReady: false\n});\n\n/**\n * Get the scene from the context.\n */\nexport const useScene = (): Nullable<Scene> => useContext(SceneContext).scene;","import { Engine, Nullable } from '@babylonjs/core';\nimport React, { createContext, useContext } from'react';\n\nexport type EngineCanvasContextType = {\n    engine: Nullable<Engine>\n    canvas: Nullable<HTMLCanvasElement | WebGLRenderingContext>\n};\n\nexport const EngineCanvasContext = createContext<EngineCanvasContextType>({\n    engine: null,\n    canvas: null\n});\n\ntype Omit<T, K extends keyof T> = Pick<T, Exclude<keyof T, K>>;\n\nexport function withEngineCanvasContext<\n  P extends { engineCanvasContext: EngineCanvasContextType },\n  R = Omit<P, 'engineCanvasContext'>\n  >(\n  Component: React.ComponentClass<P> | React.FunctionComponent<P>\n  ): React.FunctionComponent<R> {\n  return function BoundComponent(props: R) {\n    return (\n      <EngineCanvasContext.Consumer>\n        {ctx => <Component {...props as any} engineCanvasContext={ctx} />}\n      </EngineCanvasContext.Consumer>\n    );\n  };\n}\n\n/**\n * Get the engine from the context.\n */\nexport const useEngine = (): Nullable<Engine> => useContext(EngineCanvasContext).engine;\n\n/**\n * Get the canvas DOM element from the context.\n */\nexport const useCanvas = (): Nullable<HTMLCanvasElement | WebGLRenderingContext> => useContext(EngineCanvasContext).canvas;\n","import React, { useEffect, useContext, useRef, useState } from 'react';\nimport { Engine, Scene, Nullable, EngineOptions, SceneOptions, EventState, Observer, Camera } from '@babylonjs/core';\nimport { SceneContext, SceneContextType } from './scene';\nimport { EngineCanvasContext, EngineCanvasContextType } from './engine';\n\nexport * from './engine';\nexport * from './scene';\n\nexport type BabylonjsProps = {\n    antialias?: boolean\n    engineOptions?: EngineOptions\n    adaptToDeviceRatio?: boolean\n    renderChildrenWhenReady?: boolean\n    sceneOptions?: SceneOptions\n    onSceneReady: (scene: Scene) => void\n    onRender?: (scene: Scene) => void\n    id: string\n    children?: React.ReactNode\n};\n\nexport type OnFrameRenderFn = (eventData: Scene, eventState: EventState) => void\n\n/**\n * Register a callback for before the scene renders.\n * \n * @param callback called using onBeforeRender functionality of scene\n * @param mask the mask used to filter observers\n * @param insertFirst if true will be inserted at first position, if false (default) will be last position.\n * @param callOnce only call the callback once\n */\nexport const useBeforeRender = (callback: OnFrameRenderFn, mask?: number, insertFirst?: boolean, callOnce?: boolean): void => {\n    const { scene } = useContext(SceneContext);\n\n    useEffect(() => {\n        if (scene === null) {\n            return;\n        }\n\n        const unregisterOnFirstCall: boolean = callOnce === true;\n        const sceneObserver: Nullable<Observer<Scene>> = scene.onBeforeRenderObservable.add(callback, mask, insertFirst, undefined, unregisterOnFirstCall);\n\n        if (unregisterOnFirstCall !== true) {\n            return () => {\n                scene.onBeforeRenderObservable.remove(sceneObserver);\n            }\n        }\n    })\n}\n\n/**\n * Register a callback for after the scene renders.\n * \n * @param callback called using onBeforeRender functionality of scene\n * @param mask the mask used to filter observers\n * @param insertFirst if true will be inserted at first position, if false (default) will be last position.\n * @param callOnce only call the callback once\n */\nexport const useAfterRender = (callback: OnFrameRenderFn, mask?: number, insertFirst?: boolean, callOnce?: boolean): void => {\n    const { scene } = useContext(SceneContext);\n\n    useEffect(() => {\n        if (scene === null) {\n            return;\n        }\n\n        const unregisterOnFirstCall: boolean = callOnce === true;\n        const sceneObserver: Nullable<Observer<Scene>> = scene.onAfterRenderObservable.add(callback, mask, insertFirst, undefined, unregisterOnFirstCall);\n\n        if (unregisterOnFirstCall !== true) {\n            return () => {\n                scene.onAfterRenderObservable.remove(sceneObserver);\n            }\n        }\n    })\n}\n\n/**\n * Handles creating a camera and attaching/disposing.\n * TODO: add new 4.2 parameters: useCtrlForPanning & panningMouseButton\n * @param createCameraFn function that creates and returns a camera\n * @param autoAttach Attach the input controls (default true)\n * @param noPreventDefault Events caught by controls should call prevent default\n */\nexport const useCamera = <T extends Camera>(createCameraFn: (scene: Scene) => T, autoAttach: boolean = true, noPreventDefault: boolean = true): Nullable<T> => {\n    const { scene } = useContext(SceneContext);\n    const cameraRef = useRef<Nullable<T>>(null);\n\n    useEffect(() => {\n        if (scene === null) {\n            console.warn('cannot create camera (scene not ready)');\n            return;\n        }\n\n        const camera = createCameraFn(scene);\n        if (autoAttach === true) {\n            const canvas: HTMLCanvasElement = scene.getEngine()!.getRenderingCanvas()!;\n\n            // This attaches the camera to the canvas\n            // https://github.com/BabylonJS/Babylon.js/pull/9192 (keep canvas to work with < 4.2 beta-13)\n            (camera as any).attachControl(canvas, noPreventDefault);\n        }\n        cameraRef.current = camera;\n\n        return () => {\n            if (autoAttach === true) {\n                const canvas: HTMLCanvasElement = scene.getEngine()!.getRenderingCanvas()!;\n                (camera as any).detachControl(canvas);\n            }\n            camera.dispose();\n        }\n    }, [scene]);\n\n    return cameraRef.current;\n}\n\nexport default (props: BabylonjsProps) => {\n    const reactCanvas = useRef<Nullable<HTMLCanvasElement>>(null);\n    const { antialias, engineOptions, adaptToDeviceRatio, sceneOptions, onRender, onSceneReady, renderChildrenWhenReady, children, ...rest } = props;\n\n    const [sceneContext, setSceneContext] = useState<SceneContextType>({\n        scene: null,\n        sceneReady: false\n    });\n\n    const [engineContext, setEngineContext] = useState<EngineCanvasContextType>({\n        engine: null,\n        canvas: null\n    });\n\n    useEffect(() => {\n        if (reactCanvas.current) {\n            const engine = new Engine(reactCanvas.current, antialias, engineOptions, adaptToDeviceRatio);\n            setEngineContext(() => ({\n                engine,\n                canvas: reactCanvas.current\n            }));\n\n            const scene = new Scene(engine, sceneOptions);\n            const sceneIsReady = scene.isReady();\n            if (sceneIsReady) {\n                props.onSceneReady(scene);\n            } else {\n                scene.onReadyObservable.addOnce((scene) => {\n                    props.onSceneReady(scene);\n                    setSceneContext(() => ({\n                        canvas: reactCanvas.current,\n                        scene,\n                        engine,\n                        sceneReady: true,\n                    }));\n                });\n            }\n\n            engine.runRenderLoop(() => {\n                if (scene.activeCamera) {\n                    if (typeof onRender === 'function') {\n                        onRender(scene);\n                    }\n                    scene.render();\n                } else {\n                    // @babylonjs/core throws an error if you attempt to render with no active camera.\n                    // if we attach as a child React component we have frames with no active camera.\n                    console.warn('no active camera..');\n                }\n            })\n\n            const resize = () => {\n                scene.getEngine().resize();\n            }\n\n            if (window) {\n                window.addEventListener('resize', resize);\n            }\n\n            setSceneContext(() => ({\n                canvas: reactCanvas.current,\n                scene,\n                engine,\n                sceneReady: sceneIsReady,\n            }));\n\n            return () => {\n                scene.getEngine().dispose();\n\n                if (window) {\n                    window.removeEventListener('resize', resize);\n                }\n            }\n        }\n    }, [reactCanvas]);\n\n    return (\n        <>\n            <canvas ref={reactCanvas} {...rest} />\n            <EngineCanvasContext.Provider value={engineContext}>\n                <SceneContext.Provider value={sceneContext}>\n                    {(renderChildrenWhenReady !== true || (renderChildrenWhenReady === true && sceneContext.sceneReady)) &&\n                        children\n                    }\n                </SceneContext.Provider>\n            </EngineCanvasContext.Provider>\n        </>\n    );\n}"],"names":[],"mappings":"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"}